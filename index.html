<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Vietlott Data Analysis</title>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body>
    <py-config>
        packages = ["pandas", "numpy"] 
    </py-config>
    <py-script>
        from datetime import datetime, timedelta
        import pandas as pd
        import numpy as np

        from pyodide.http import open_url

        BASE_URL = "https://raw.githubusercontent.com/haah82/vietlott-data-update/main/data/"
        PRODUCTS = {
            "Power 6/55": "power655.jsonl",
            "Power 6/45": "power645.jsonl",
            "Power 5/35": "power535.jsonl",
            "Keno": "keno.jsonl",
            "Max 3D": "3d.jsonl",
            "Max 3D Pro": "3d_pro.jsonl",
            "Bingo18": "bingo18.jsonl"
        }

        def get_data_overview():
            overview = []
            for name, filename in PRODUCTS.items():
                try:
                    url = BASE_URL + filename
                    df = pd.read_json(open_url(url), lines=True)
                    if not df.empty:
                        df['date'] = pd.to_datetime(df['date'])
                        overview.append({
                            "Product": name,
                            "Total Draws": df['date'].nunique(),
                            "Start Date": df['date'].min().strftime('%Y-%m-%d'),
                            "End Date": df['date'].max().strftime('%Y-%m-%d'),
                            "Total Records": df['id'].nunique(),
                            "Latest ID": df['id'].max()
                        })
                except Exception as e:
                    print(f"Error loading {name}: {e}")
            return pd.DataFrame(overview)

        # Display Data Statistics Overview
        stats_overview = get_data_overview()
        display(stats_overview, target='data_statistics')

        # Detailed Power 6/55 Analysis (Original code)
        url_655 = BASE_URL + "power655.jsonl"
        data_655 = pd.read_json(open_url(url_655), lines=True)
        data_655['date'] = pd.to_datetime(data_655['date']).dt.date
        data_655 = data_655.sort_values(by=['date', 'id'], ascending=False)

        # plot
        def fn_stats(df_, window_time=None):
            if window_time is not None:
                df_ = df_[df_['date'] >= (datetime.now().date() - timedelta(days=window_time))]
            df_explode = df_.explode('result')
            stats = df_explode.groupby('result').agg(
                count=('id', 'count')
            )
            stats['%'] = (stats['count'] / len(df_explode) * 100).round(2)
            return stats
        
        stats = fn_stats(data_655)

        # stats n months
        stats_15d = fn_stats(data_655, 15)
        stats_30d = fn_stats(data_655, 30)
        stats_60d = fn_stats(data_655, 60)
        stats_90d = fn_stats(data_655, 90)
        
        display(stats, target='stats_all_time')
        display(stats_15d, target='stats_15d')
        display(stats_30d, target='stats_30d')
        display(stats_60d, target='stats_60d')
        display(stats_90d, target='stats_90d')

    </py-script>

    <py-repl>
        data_655
    </py-repl>

    <div>
        <h1>ğŸ“Š Thá»‘ng kÃª dá»¯ liá»‡u / Data Statistics</h1>
        <div id="data_statistics"></div>
        
        <hr>
        <h1>ğŸ“ˆ Power 6/55 Detailed Analysis</h1>
        
        <h2>All time</h2>
        <div id="stats_all_time"></div>
        <h2>15d</h2>
        <div id="stats_15d"></div>
        <h2>30d</h2>
        <div id="stats_30d"></div>
        <h2>60d</h2>
        <div id="stats_60d"></div>
        <h2>90d</h2>
        <div id="stats_90d"></div>
        
    </div>
    
</body>

</html>